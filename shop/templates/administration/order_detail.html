{% extends 'administration/base.html' %}

{% block title %}Détails de la commande - Admin{% endblock %}

{% block page_title %}Détails de la commande{% endblock %}
{% block page_subtitle %}Commande #{{ order.order_number }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- En-tête de la commande -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Commande #{{ order.order_number }}</h3>
                    <p class="text-sm text-gray-600">Passée le {{ order.created_at|date:"d/m/Y à H:i" }}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                {% if order.status == 'PENDING' %}bg-yellow-100 text-yellow-800
                                {% elif order.status == 'CONFIRMED' %}bg-blue-100 text-blue-800
                                {% elif order.status == 'SHIPPED' %}bg-purple-100 text-purple-800
                                {% elif order.status == 'DELIVERED' %}bg-green-100 text-green-800
                                {% elif order.status == 'CANCELLED' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                        <span class="w-2 h-2 rounded-full mr-1
                                    {% if order.status == 'PENDING' %}bg-yellow-600
                                    {% elif order.status == 'CONFIRMED' %}bg-blue-600
                                    {% elif order.status == 'SHIPPED' %}bg-purple-600
                                    {% elif order.status == 'DELIVERED' %}bg-green-600
                                    {% elif order.status == 'CANCELLED' %}bg-red-600
                                    {% else %}bg-gray-600{% endif %}"></span>
                        {{ order.get_status_display }}
                    </span>
                    <a href="/administration/orders/" class="text-gray-600 hover:text-gray-900 transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined">arrow_back</span>
                        Retour
                    </a>
                </div>
            </div>
        </div>

        <!-- Informations client -->
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-semibold text-gray-900 mb-3">Informations client</h4>
                <div class="space-y-2">
                    <p><strong>Nom :</strong> {{ order.full_name }}</p>
                    <p><strong>Email :</strong> {{ order.email }}</p>
                    <p><strong>Téléphone :</strong> {{ order.phone_number }}</p>
                </div>
            </div>
            <div>
                <h4 class="font-semibold text-gray-900 mb-3">Adresse de livraison</h4>
                <div class="space-y-2">
                    <p><strong>Adresse :</strong> {{ order.address }}</p>
                    <p><strong>Ville :</strong> {{ order.city }}</p>
                    <p><strong>Pays :</strong> {{ order.country }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Articles de la commande -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Articles commandés</h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                {% for item in order.items.all %}
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-4">
                        <!-- Image du produit avec fallback -->
                        <div class="relative">
                            {% if item.product.image %}
                                <img src="{{ item.product.image.url }}" alt="{{ item.product_name }}" class="w-16 h-16 object-cover rounded-lg">
                            {% else %}
                                <!-- Image par défaut stylisée -->
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg flex items-center justify-center border border-gray-200">
                                    {% if item.product.product_type == 'SHEET' %}
                                        <span class="material-symbols-outlined text-blue-600 text-2xl">bed</span>
                                    {% elif item.product.product_type == 'PHONE' %}
                                        <span class="material-symbols-outlined text-purple-600 text-2xl">smartphone</span>
                                    {% else %}
                                        <span class="material-symbols-outlined text-gray-600 text-2xl">shopping_bag</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>

                        <div>
                            <h4 class="font-medium text-gray-900">{{ item.product_name }}</h4>
                            <p class="text-sm text-gray-600">
                                {% if item.product %}
                                    {% if item.product.product_type == 'SHEET' %}
                                        {{ item.product.get_sheet_size_display }} • {{ item.product.get_color_display }}
                                        {% if item.product.material %}• {{ item.product.material }}{% endif %}
                                    {% elif item.product.product_type == 'PHONE' %}
                                        {{ item.product.get_phone_brand_display }}
                                        {% if item.product.storage %}• {{ item.product.storage }}{% endif %}
                                        {% if item.product.screen_size %}• Écran {{ item.product.screen_size }}{% endif %}
                                    {% endif %}
                                {% else %}
                                    <span class="text-orange-600">Produit supprimé</span>
                                {% endif %}
                            </p>
                            <div class="flex items-center gap-2 mt-1">
                                <p class="text-xs text-gray-500">Ref: {{ item.product.id }}</p>
                                <p class="text-xs text-gray-500">Prix: {{ item.product_price }} €</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">{{ item.quantity }} × {{ item.product_price }} €</p>
                        <p class="text-lg font-bold text-gray-900">{{ item.get_total_price|floatformat:2 }} €</p>
                        {% if item.product.discount_percentage > 0 %}
                        <p class="text-xs text-green-600">Promo: -{{ item.product.discount_percentage }}%</p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8">
                    <span class="material-symbols-outlined text-4xl text-gray-300 mb-2">shopping_bag</span>
                    <p class="text-gray-500">Aucun article dans cette commande</p>
                </div>
                {% endfor %}
            </div>

            <!-- Total de la commande -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center text-lg font-semibold">
                    <span>Total de la commande:</span>
                    <span>{{ order.total_price|floatformat:2 }} €</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Résumé et actions -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Résumé financier -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h4 class="font-semibold text-gray-900 mb-4">Résumé</h4>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-600">Sous-total</span>
                    <span class="font-medium">{{ order.total_price|floatformat:2 }} €</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Livraison</span>
                    <span class="font-medium text-green-600">Gratuite</span>
                </div>
                <div class="border-t pt-3 flex justify-between text-lg font-bold">
                    <span>Total</span>
                    <span>{{ order.total_price|floatformat:2 }} €</span>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h4 class="font-semibold text-gray-900 mb-4">Actions</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Confirmer - seulement si en attente -->
                {% if order.status == 'PENDING' %}
                <form method="post" action="/administration/orders/{{ order.id }}/confirm/">
                    {% csrf_token %}
                    <button type="submit"
                            class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">check_circle</span>
                        Confirmer la commande
                    </button>
                </form>
                {% else %}
                <button disabled class="w-full bg-gray-300 text-gray-500 px-4 py-3 rounded-lg cursor-not-allowed flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    Déjà confirmée
                </button>
                {% endif %}

                <!-- Changer statut -->
                <form method="post" action="/administration/orders/{{ order.id }}/update-status/">
                    {% csrf_token %}
                    <div class="flex gap-2">
                        <select name="status" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="PENDING" {% if order.status == 'PENDING' %}selected{% endif %}>En attente</option>
                            <option value="CONFIRMED" {% if order.status == 'CONFIRMED' %}selected{% endif %}>Confirmée</option>
                            <option value="SHIPPED" {% if order.status == 'SHIPPED' %}selected{% endif %}>Expédiée</option>
                            <option value="DELIVERED" {% if order.status == 'DELIVERED' %}selected{% endif %}>Livrée</option>
                            <option value="CANCELLED" {% if order.status == 'CANCELLED' %}selected{% endif %}>Annulée</option>
                        </select>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <span class="material-symbols-outlined">save</span>
                        </button>
                    </div>
                </form>

                <!-- Annuler - seulement si pas annulée ou livrée -->
                {% if order.status != 'CANCELLED' and order.status != 'DELIVERED' %}
                <form method="post" action="/administration/orders/{{ order.id }}/cancel/">
                    {% csrf_token %}
                    <button type="submit"
                            onclick="return confirm('Êtes-vous sûr de vouloir annuler cette commande ? Le stock sera réapprovisionné.')"
                            class="w-full bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">cancel</span>
                        Annuler la commande
                    </button>
                </form>
                {% else %}
                <button disabled class="w-full bg-gray-300 text-gray-500 px-4 py-3 rounded-lg cursor-not-allowed flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">cancel</span>
                    Non annulable
                </button>
                {% endif %}

                <!-- Exporter -->
                <a href="/administration/orders/{{ order.id }}/export/"
                   class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                   target="_blank">
                    <span class="material-symbols-outlined">download</span>
                    Exporter en PDF
                </a>
            </div>
        </div>
    </div>

    <!-- Historique des modifications -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Historique</h3>
        </div>
        <div class="p-6">
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="material-symbols-outlined text-green-600">add_shopping_cart</span>
                        <div>
                            <p class="font-medium">Commande créée</p>
                            <p class="text-sm text-gray-600">Par le client</p>
                        </div>
                    </div>
                    <span class="text-sm text-gray-500">{{ order.created_at|date:"d/m/Y H:i" }}</span>
                </div>
                {% if order.status != 'PENDING' %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="material-symbols-outlined
                                    {% if order.status == 'CONFIRMED' %}text-blue-600
                                    {% elif order.status == 'SHIPPED' %}text-purple-600
                                    {% elif order.status == 'DELIVERED' %}text-green-600
                                    {% elif order.status == 'CANCELLED' %}text-red-600
                                    {% else %}text-gray-600{% endif %}">event_available</span>
                        <div>
                            <p class="font-medium">Statut modifié: {{ order.get_status_display }}</p>
                            <p class="text-sm text-gray-600">Par l'administrateur</p>
                        </div>
                    </div>
                    <span class="text-sm text-gray-500">{{ order.updated_at|date:"d/m/Y H:i" }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}