{% extends 'administration/base.html' %}

{% block title %}Modifier le produit - Admin{% endblock %}

{% block page_title %}Modifier le produit{% endblock %}
{% block page_subtitle %}{{ product.name }}{% endblock %}

{% block content %}

<div class="max-w-6xl mx-auto px-3 sm:px-4 lg:px-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <!-- En-t√™te -->
        <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="flex-1 min-w-0">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-900">Modifier le produit</h3>
                    <p class="text-sm text-gray-600">Modifiez les informations de "{{ product.name }}"</p>
                </div>
                <a href="/gestion-securisee/products/" class="text-gray-600 hover:text-gray-900 transition-colors flex items-center gap-2 text-sm sm:text-base w-full sm:w-auto justify-center sm:justify-start">
                    <span class="material-symbols-outlined text-base">arrow_back</span>
                    Retour √† la liste
                </a>
            </div>
        </div>

        <!-- Messages d'alerte -->
        {% if messages %}
            <div class="mx-4 sm:mx-6 mt-4">
                {% for message in messages %}
                    <div class="p-3 sm:p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %}">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined mr-2 text-sm sm:text-base">
                                {% if message.tags == 'error' %}error{% else %}check_circle{% endif %}
                            </span>
                            <span class="text-sm sm:text-base">{{ message }}</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Formulaire -->
        <form method="post" enctype="multipart/form-data" class="p-4 sm:p-6 space-y-4 sm:space-y-6">
            {% csrf_token %}

            <!-- Informations de base -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <!-- Nom du produit -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Nom du produit *</label>
                    <input type="text" id="name" name="name" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                           placeholder="Ex: iPhone 15 Pro Max"
                           value="{{ product.name }}">
                </div>

                <!-- Prix -->
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700 mb-2">Prix (FCFA) *</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" required
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                       placeholder="0.00"
                       value="{% if product.price %}{{ product.price }}{% endif %}">
                </div>
            </div>

            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                <textarea id="description" name="description" required rows="4"
                          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors resize-none"
                          placeholder="D√©crivez le produit en d√©tail...">{{ product.description }}</textarea>
            </div>

            <!-- Type de produit -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Type de produit *</label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4" id="product-type-selector">
                    <!-- OPTION MODIFI√âE : √âlectronique & Accessoires -->
                    <label class="relative flex cursor-pointer rounded-lg border border-gray-300 p-3 sm:p-4 focus:outline-none product-type-option transition-all duration-200">
                        <input type="radio" name="product_type" value="ELECTRONICS" class="sr-only" required
                               {% if product.product_type == 'ELECTRONICS' %}checked{% endif %}>
                        <div class="flex w-full items-center justify-between">
                            <div class="flex items-center">
                                <div class="text-xs sm:text-sm">
                                    <span class="font-medium text-gray-900">√âlectronique & Accessoires</span>
                                    <p class="text-gray-500 hidden xs:block">Smartphones, tablettes, accessoires</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-gray-400 text-base sm:text-lg">devices</span>
                        </div>
                    </label>

                    <!-- OPTION : D√©co & Am√©nagement -->
                    <label class="relative flex cursor-pointer rounded-lg border border-gray-300 p-3 sm:p-4 focus:outline-none product-type-option transition-all duration-200">
                        <input type="radio" name="product_type" value="DECORATION" class="sr-only" required
                               {% if product.product_type == 'DECORATION' %}checked{% endif %}>
                        <div class="flex w-full items-center justify-between">
                            <div class="flex items-center">
                                <div class="text-xs sm:text-sm">
                                    <span class="font-medium text-gray-900">D√©co & Am√©nagement</span>
                                    <p class="text-gray-500 hidden xs:block">Draps, rideaux, tapis et linge de maison</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-gray-400 text-base sm:text-lg">home</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- SECTION : Sp√©cifications pour la D√âCORATION -->
            <div id="decoration-specs" class="{% if product.product_type != 'DECORATION' %}hidden{% endif %} space-y-4 sm:space-y-6 p-3 sm:p-4 bg-purple-50 rounded-lg">
                <h4 class="font-semibold text-purple-900 text-sm sm:text-base">Sp√©cifications de la d√©coration</h4>

                <!-- Type de d√©coration -->
                <div>
                    <label for="decoration_type" class="block text-sm font-medium text-gray-700 mb-2">Type de produit *</label>
                    <select id="decoration_type" name="decoration_type"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                        <option value="">S√©lectionnez un type</option>
                        <option value="SHEET" {% if product.decoration_type == 'SHEET' %}selected{% endif %}>Draps</option>
                        <option value="CURTAIN" {% if product.decoration_type == 'CURTAIN' %}selected{% endif %}>Rideaux</option>
                        <option value="CARPET" {% if product.decoration_type == 'CARPET' %}selected{% endif %}>Tapis</option>
                        <option value="OTHER" {% if product.decoration_type == 'OTHER' %}selected{% endif %}>Autre d√©coration</option>
                    </select>
                </div>

                <!-- Sp√©cifications pour les DRAPS -->
                <div id="sheet-specs" class="{% if product.decoration_type != 'SHEET' %}hidden{% endif %} space-y-4 sm:space-y-6 p-3 sm:p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-900 text-sm sm:text-base">Sp√©cifications des draps</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                        <!-- Taille -->
                        <div>
                            <label for="sheet_size" class="block text-sm font-medium text-gray-700 mb-2">Taille</label>
                            <select id="sheet_size" name="sheet_size"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                                <option value="">S√©lectionnez une taille</option>
                                <option value="SIMPLE" {% if product.sheet_size == 'SIMPLE' %}selected{% endif %}>Simple (90x190cm)</option>
                                <option value="DOUBLE" {% if product.sheet_size == 'DOUBLE' %}selected{% endif %}>Double (140x190cm)</option>
                                <option value="QUEEN" {% if product.sheet_size == 'QUEEN' %}selected{% endif %}>Queen (160x200cm)</option>
                                <option value="KING" {% if product.sheet_size == 'KING' %}selected{% endif %}>King (180x200cm)</option>
                            </select>
                        </div>

                        <!-- Couleur -->
                        <div>
                            <label for="color" class="block text-sm font-medium text-gray-700 mb-2">Couleur</label>
                            <select id="color" name="color"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                                <option value="">S√©lectionnez une couleur</option>
                                <option value="WHITE" {% if product.color == 'WHITE' %}selected{% endif %}>Blanc</option>
                                <option value="GRAY" {% if product.color == 'GRAY' %}selected{% endif %}>Gris</option>
                                <option value="BLUE" {% if product.color == 'BLUE' %}selected{% endif %}>Bleu</option>
                                <option value="PINK" {% if product.color == 'PINK' %}selected{% endif %}>Rose</option>
                                <option value="GREEN" {% if product.color == 'GREEN' %}selected{% endif %}>Vert</option>
                                <option value="BEIGE" {% if product.color == 'BEIGE' %}selected{% endif %}>Beige</option>
                            </select>
                        </div>

                        <!-- Mati√®re -->
                        <div class="md:col-span-2">
                            <label for="material" class="block text-sm font-medium text-gray-700 mb-2">Mati√®re</label>
                            <input type="text" id="material" name="material"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                   placeholder="Ex: Coton 100%, Polyester..."
                                   value="{{ product.material|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Option "Sur devis personnalis√©" -->
                <div class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200">
                    <input type="checkbox" id="needs_custom_quote" name="needs_custom_quote"
                           class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
                           {% if product.needs_custom_quote %}checked{% endif %}>
                    <div>
                        <label for="needs_custom_quote" class="block text-sm font-medium text-gray-700">
                            Produit sur devis personnalis√©
                        </label>
                        <p class="text-xs text-gray-500 mt-1">
                            Cochez si ce produit n√©cessite une visite et un devis personnalis√© (prix √† 0)
                        </p>
                    </div>
                </div>

                <!-- Prix au m¬≤ (pour les tapis) -->
                <div id="price-per-sqm-container" class="{% if product.decoration_type != 'CARPET' %}hidden{% endif %}">
                    <label for="price_per_sqm" class="block text-sm font-medium text-gray-700 mb-2">Prix au m¬≤ (FCFA)</label>
                    <input type="number" id="price_per_sqm" name="price_per_sqm" step="0.01" min="0"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                           placeholder="0.00"
                           value="{{ product.price_per_sqm|default:'' }}">
                    <p class="text-xs text-gray-500 mt-1">Pour les tapis vendus au m√®tre carr√©</p>
                </div>

                <!-- Message d'information pour les produits sur devis -->
                <div id="custom-quote-info" class="{% if not product.needs_custom_quote %}hidden{% endif %} p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-start gap-2">
                        <span class="material-symbols-outlined text-yellow-600 text-sm mt-0.5">info</span>
                        <div>
                            <p class="text-sm font-medium text-yellow-800">Produit sur devis</p>
                            <p class="text-xs text-yellow-700 mt-1">
                                Le prix sera fix√© √† 0 FCFA. Les clients devront demander un devis personnalis√©.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION MODIFI√âE : Sp√©cifications pour les PRODUITS √âLECTRONIQUES -->
            <div id="electronics-specs" class="{% if product.product_type != 'ELECTRONICS' %}hidden{% endif %} space-y-4 sm:space-y-6 p-3 sm:p-4 bg-green-50 rounded-lg">
                <h4 class="font-semibold text-green-900 text-sm sm:text-base">Sp√©cifications des produits √©lectroniques</h4>

                <!-- Cat√©gorie √©lectronique -->
                <div>
                    <label for="electronics_category" class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie *</label>
                    <select id="electronics_category" name="electronics_category"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                        <option value="">S√©lectionnez une cat√©gorie</option>
                        <option value="SMARTPHONE" {% if product.electronics_category == 'SMARTPHONE' %}selected{% endif %}>Smartphones</option>
                        <option value="TABLET" {% if product.electronics_category == 'TABLET' %}selected{% endif %}>Tablettes</option>
                        <option value="HEADPHONE" {% if product.electronics_category == 'HEADPHONE' %}selected{% endif %}>Casques audio</option>
                        <option value="CHARGER" {% if product.electronics_category == 'CHARGER' %}selected{% endif %}>Chargeurs & C√¢bles</option>
                        <option value="SMARTWATCH" {% if product.electronics_category == 'SMARTWATCH' %}selected{% endif %}>Montres connect√©es</option>
                        <option value="EARBUDS" {% if product.electronics_category == 'EARBUDS' %}selected{% endif %}>√âcouteurs</option>
                        <option value="POWERBANK" {% if product.electronics_category == 'POWERBANK' %}selected{% endif %}>Power banks</option>
                        <option value="PHONE_CASE" {% if product.electronics_category == 'PHONE_CASE' %}selected{% endif %}>Coques & Protection</option>
                        <option value="REFURBISHED" {% if product.electronics_category == 'REFURBISHED' %}selected{% endif %}>Reconditionn√©s</option>
                        <option value="OTHER_ACCESSORY" {% if product.electronics_category == 'OTHER_ACCESSORY' %}selected{% endif %}>Autres accessoires</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6" id="electronics-fields">
                    <!-- Marque -->
                    <div class="electronics-field" data-categories="all">
                        <label for="phone_brand" class="block text-sm font-medium text-gray-700 mb-2">Marque *</label>
                        <input type="text" id="phone_brand" name="phone_brand"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: Apple, Samsung, Huawei, Sony, JBL..."
                               value="{{ product.phone_brand|default:'' }}">
                        <p class="text-xs text-gray-500 mt-1">Entrez le nom de la marque du produit</p>
                    </div>

                    <!-- Stockage -->
                    <div class="electronics-field" data-categories="SMARTPHONE,TABLET,REFURBISHED">
                        <label for="storage" class="block text-sm font-medium text-gray-700 mb-2">Stockage</label>
                        <input type="text" id="storage" name="storage"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: 128GB, 256GB..."
                               value="{{ product.storage|default:'' }}">
                    </div>

                    <!-- Taille √©cran -->
                    <div class="electronics-field" data-categories="SMARTPHONE,TABLET,SMARTWATCH,REFURBISHED">
                        <label for="screen_size" class="block text-sm font-medium text-gray-700 mb-2">Taille √©cran</label>
                        <input type="text" id="screen_size" name="screen_size"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: 6.1 pouces, 10.9 pouces..."
                               value="{{ product.screen_size|default:'' }}">
                    </div>

                    <!-- Processeur -->
                    <div class="electronics-field" data-categories="SMARTPHONE,TABLET,REFURBISHED">
                        <label for="processor" class="block text-sm font-medium text-gray-700 mb-2">Processeur</label>
                        <input type="text" id="processor" name="processor"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: Snapdragon 8 Gen 2, A17 Pro..."
                               value="{{ product.processor|default:'' }}">
                    </div>

                    <!-- RAM -->
                    <div class="electronics-field" data-categories="SMARTPHONE,TABLET,REFURBISHED">
                        <label for="ram" class="block text-sm font-medium text-gray-700 mb-2">M√©moire RAM</label>
                        <input type="text" id="ram" name="ram"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: 8GB, 12GB..."
                               value="{{ product.ram|default:'' }}">
                    </div>

                    <!-- Appareil photo -->
                    <div class="electronics-field md:col-span-2" data-categories="SMARTPHONE,TABLET,REFURBISHED">
                        <label for="camera" class="block text-sm font-medium text-gray-700 mb-2">Appareil photo</label>
                        <input type="text" id="camera" name="camera"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: Triple cam√©ra 50MP + 12MP + 12MP"
                               value="{{ product.camera|default:'' }}">
                    </div>

                    <!-- Batterie -->
                    <div class="electronics-field" data-categories="SMARTPHONE,TABLET,SMARTWATCH,EARBUDS,POWERBANK,REFURBISHED">
                        <label for="battery" class="block text-sm font-medium text-gray-700 mb-2">Batterie</label>
                        <input type="text" id="battery" name="battery"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: 5000 mAh, 20h d'autonomie..."
                               value="{{ product.battery|default:'' }}">
                    </div>

                    <!-- Syst√®me d'exploitation -->
                    <div class="electronics-field" data-categories="SMARTPHONE,TABLET,SMARTWATCH,REFURBISHED">
                        <label for="operating_system" class="block text-sm font-medium text-gray-700 mb-2">Syst√®me d'exploitation</label>
                        <input type="text" id="operating_system" name="operating_system"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: Android 14, iOS 17, WatchOS..."
                               value="{{ product.operating_system|default:'' }}">
                    </div>

                    <!-- Connectivit√© -->
                    <div class="electronics-field md:col-span-2" data-categories="SMARTPHONE,TABLET,SMARTWATCH,HEADPHONE,EARBUDS,REFURBISHED">
                        <label for="connectivity" class="block text-sm font-medium text-gray-700 mb-2">Connectivit√©</label>
                        <input type="text" id="connectivity" name="connectivity"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               placeholder="Ex: 5G, Wi-Fi 6, Bluetooth 5.3..."
                               value="{{ product.connectivity|default:'' }}">
                    </div>
                </div>
            </div>

            <!-- Stock et promotion -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <!-- Stock -->
                <div>
                    <label for="stock" class="block text-sm font-medium text-gray-700 mb-2">Stock *</label>
                    <input type="number" id="stock" name="stock" min="0" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                           placeholder="0"
                           value="{{ product.stock }}">
                </div>

                <!-- Promotion -->
                <div>
                    <label for="discount_percentage" class="block text-sm font-medium text-gray-700 mb-2">Promotion (%)</label>
                    <input type="number" id="discount_percentage" name="discount_percentage" min="0" max="100"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm sm:text-base focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                           placeholder="0"
                           value="{{ product.discount_percentage|default:'0' }}">
                </div>
            </div>

            <!-- Image principale -->
            <div>
                <label for="main_image" class="block text-sm font-medium text-gray-700 mb-2">
                    Image principale
                </label>

                <!-- Image principale actuelle -->
                {% if product.image_url %}
                <div class="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm font-medium text-gray-700 mb-2">Image principale actuelle :</p>
                    <div class="flex items-center space-x-4">
                        <img src="{{ product.image_url }}" alt="{{ product.name }}" class="h-20 w-20 object-cover rounded-lg border-2 border-green-500">
                        <div>
                            <p class="text-sm text-gray-900">Image principale</p>
                            <p class="text-xs text-gray-500">Conserver cette image si aucun nouveau fichier n'est s√©lectionn√©</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Nouvelle image principale -->
                <input type="file" id="main_image" name="main_image"
                       class="block w-full text-xs sm:text-sm text-gray-500
                              file:mr-2 sm:file:mr-4 file:py-2 sm:file:py-3 file:px-3 sm:file:px-4
                              file:rounded-lg file:border-0
                              file:text-xs sm:file:text-sm file:font-semibold
                              file:bg-primary file:text-white
                              hover:file:bg-primary-dark transition-colors
                              border border-gray-300 rounded-lg"
                       accept="image/*"
                       onchange="previewMainImage(this)">

                <p class="mt-1 text-xs text-gray-500">Formats support√©s: JPG, PNG, GIF (max 10MB). Laisser vide pour conserver l'image actuelle.</p>

                <!-- Aper√ßu nouvelle image principale -->
                <div id="main-image-preview" class="mt-3 hidden p-3 sm:p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm font-medium text-gray-700 mb-2">Nouvel aper√ßu :</p>
                    <div class="flex items-center space-x-4">
                        <img id="main-preview" class="h-20 w-20 object-cover rounded-lg border border-gray-300">
                        <div>
                            <p id="main-file-name" class="text-sm font-medium text-gray-900"></p>
                            <p id="main-file-size" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Images suppl√©mentaires existantes -->
            {% if product_images %}
            <div class="border-t pt-6 mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Images suppl√©mentaires existantes
                    <span class="text-xs text-gray-500">(Total: {{ product_images.count }})</span>
                </label>

                <div id="existing-images-container" class="space-y-4">
                    {% for product_image in product_images %}
                    <div class="existing-image-field border border-gray-300 rounded-lg p-4 bg-blue-50" data-image-id="{{ product_image.id }}">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-medium text-gray-700">
                                Image suppl√©mentaire {{ forloop.counter }}
                                <span class="text-xs font-normal text-gray-500">(ID: {{ product_image.id }})</span>
                            </label>
                            <button type="button" onclick="removeExistingImage({{ product_image.id }})"
                                    class="text-red-600 hover:text-red-800 text-sm flex items-center gap-1">
                                <span class="material-symbols-outlined text-base">delete</span>
                                Supprimer
                            </button>
                        </div>

                        <div class="flex items-center space-x-4">
                            <img src="{{ product_image.image_url }}" alt="Image produit"
                                 class="h-20 w-20 object-cover rounded-lg border border-gray-300">
                            <div>
                                <p class="text-sm text-gray-900">Image existante</p>
                                <p class="text-xs text-gray-500">ID: {{ product_image.id }}</p>
                                {% if product_image.is_primary %}
                                <span class="inline-block mt-1 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                    Image principale
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Nouvelles images suppl√©mentaires -->
            <div class="border-t pt-6 mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Ajouter de nouvelles images suppl√©mentaires
                </label>

                <div id="additional-images-container" class="space-y-4">
                    <!-- Premier champ pour nouvelle image -->
                    <div class="additional-image-field border border-gray-300 rounded-lg p-4 bg-green-50">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-medium text-gray-700">Nouvelle image suppl√©mentaire 1</label>
                            <button type="button" onclick="removeAdditionalImageField(this)" class="text-red-600 hover:text-red-800 text-sm flex items-center gap-1">
                                <span class="material-symbols-outlined text-base">delete</span>
                                Supprimer
                            </button>
                        </div>

                        <input type="file"
                               name="additional_images"
                               class="block w-full text-xs sm:text-sm text-gray-500
                                      file:mr-2 sm:file:mr-4 file:py-2 sm:file:py-3 file:px-3 sm:file:px-4
                                      file:rounded-lg file:border-0
                                      file:text-xs sm:file:text-sm file:font-semibold
                                      file:bg-green-600 file:text-white
                                      hover:file:bg-green-700 transition-colors
                                      border border-gray-300 rounded-lg"
                               accept="image/*"
                               onchange="previewAdditionalImage(this, 0)">

                        <!-- Aper√ßu nouvelle image -->
                        <div id="additional-preview-0" class="mt-3 hidden p-3 bg-white rounded-lg border">
                            <p class="text-sm font-medium text-gray-700 mb-2">Aper√ßu :</p>
                            <div class="flex items-center space-x-4">
                                <img id="additional-img-0" class="h-16 w-16 object-cover rounded-lg border border-gray-300">
                                <div>
                                    <p id="additional-file-name-0" class="text-sm font-medium text-gray-900"></p>
                                    <p id="additional-file-size-0" class="text-xs text-gray-500"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bouton pour ajouter plus d'images -->
                <button type="button" onclick="addAdditionalImageField()" class="mt-4 flex items-center gap-2 text-green-600 hover:text-green-700 text-sm font-medium">
                    <span class="material-symbols-outlined text-base">add</span>
                    Ajouter une autre image
                </button>
            </div>

            <div id="remove-images-container">
                <!-- Les champs seront ajout√©s ici dynamiquement -->
            </div>

            <!-- Boutons -->
            <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 sm:space-x-4 pt-6 border-t border-gray-200">
                <a href="/gestion-securisee/products/" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors text-center text-sm sm:text-base">
                    Annuler
                </a>

                <button type="submit"
                        class="bg-primary text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2 text-sm sm:text-base">
                    <span class="material-symbols-outlined text-base">save</span>
                    <span>Modifier le produit</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Script pour la gestion des sp√©cifications par type -->
<script>
// Variable globale pour stocker les IDs √† supprimer
let imagesToRemove = [];

// Fonction pour supprimer une image existante - NOUVELLE APPROCHE
function removeExistingImage(imageId) {
    console.log("=== TENTATIVE DE SUPPRESSION ===");
    console.log("ID de l'image √† supprimer:", imageId);

    if (confirm('Voulez-vous vraiment supprimer cette image ?')) {
        // Ajouter l'ID √† la liste des images √† supprimer
        if (!imagesToRemove.includes(imageId)) {
            imagesToRemove.push(imageId);
            console.log("‚úÖ ID ajout√© √† la liste de suppression:", imagesToRemove);
        }

        // Mettre √† jour les champs cach√©s
        updateRemoveImageFields();

        // Marquer visuellement l'√©l√©ment
        const imageElement = document.querySelector(`button[onclick="removeExistingImage(${imageId})"]`).closest('.existing-image-field');
        if (imageElement) {
            imageElement.style.opacity = '0.4';
            imageElement.style.backgroundColor = '#fef2f2';
            imageElement.style.borderColor = '#ef4444';
            imageElement.classList.add('to-be-deleted');

            const deleteButton = imageElement.querySelector('button');
            if (deleteButton) {
                deleteButton.disabled = true;
                deleteButton.innerHTML = '<span class="material-symbols-outlined text-base">delete</span> Supprim√©e';
                deleteButton.classList.remove('text-red-600', 'hover:text-red-800');
                deleteButton.classList.add('text-gray-400', 'cursor-not-allowed');
            }
        }

        console.log("=== SUPPRESSION CONFIRM√âE ===");
    }
}

// Fonction pour mettre √† jour les champs cach√©s
function updateRemoveImageFields() {
    const container = document.getElementById('remove-images-container');

    // Vider le conteneur
    container.innerHTML = '';

    // Ajouter un champ cach√© pour chaque ID √† supprimer
    imagesToRemove.forEach(imageId => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'remove_image_ids';
        hiddenInput.value = imageId;
        container.appendChild(hiddenInput);
    });

    console.log("üîÑ Champs cach√©s mis √† jour. IDs:", imagesToRemove);
}

// Gestion de l'affichage des sp√©cifications par type de produit
document.addEventListener('DOMContentLoaded', function() {
    const productTypeRadios = document.querySelectorAll('input[name="product_type"]');
    const electronicsSpecs = document.getElementById('electronics-specs');
    const decorationSpecs = document.getElementById('decoration-specs');
    const sheetSpecs = document.getElementById('sheet-specs');

    function updateSpecifications() {
        const selectedType = document.querySelector('input[name="product_type"]:checked');

        electronicsSpecs.classList.add('hidden');
        decorationSpecs.classList.add('hidden');
        sheetSpecs.classList.add('hidden');

        document.querySelectorAll('.product-type-option').forEach(option => {
            option.classList.remove('border-primary', 'bg-blue-50', 'ring-2', 'ring-primary');
            option.classList.add('border-gray-300');
            const icon = option.querySelector('.material-symbols-outlined');
            icon.classList.remove('text-green-600', 'text-purple-600');
            icon.classList.add('text-gray-400');
        });

        if (selectedType) {
            const selectedOption = selectedType.closest('.product-type-option');
            selectedOption.classList.remove('border-gray-300');
            selectedOption.classList.add('border-primary', 'bg-blue-50', 'ring-2', 'ring-primary');

            const icon = selectedOption.querySelector('.material-symbols-outlined');
            icon.classList.remove('text-gray-400');

            if (selectedType.value === 'ELECTRONICS') {
                electronicsSpecs.classList.remove('hidden');
                icon.classList.add('text-green-600');
                updateElectronicsFields();
            } else if (selectedType.value === 'DECORATION') {
                decorationSpecs.classList.remove('hidden');
                icon.classList.add('text-purple-600');
                updateDecorationSpecs();
            }
        }
    }

    function updateElectronicsFields() {
        const category = document.getElementById('electronics_category').value;
        const allFields = document.querySelectorAll('.electronics-field');

        allFields.forEach(field => {
            const fieldCategories = field.getAttribute('data-categories').split(',');
            if (fieldCategories.includes('all') || fieldCategories.includes(category)) {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        });
    }

    function updateDecorationSpecs() {
        const decorationType = document.getElementById('decoration_type').value;
        const needsCustomQuote = document.getElementById('needs_custom_quote').checked;
        const pricePerSqmContainer = document.getElementById('price-per-sqm-container');
        const customQuoteInfo = document.getElementById('custom-quote-info');
        const priceInput = document.getElementById('price');

        if (decorationType === 'SHEET') {
            sheetSpecs.classList.remove('hidden');
        } else {
            sheetSpecs.classList.add('hidden');
        }

        if (decorationType === 'CARPET') {
            pricePerSqmContainer.classList.remove('hidden');
        } else {
            pricePerSqmContainer.classList.add('hidden');
        }

        if (needsCustomQuote) {
            customQuoteInfo.classList.remove('hidden');
            priceInput.value = '0';
            priceInput.disabled = true;
            priceInput.placeholder = 'Prix fix√© √† 0 (sur devis)';
        } else {
            customQuoteInfo.classList.add('hidden');
            priceInput.disabled = false;
            priceInput.placeholder = '0.00';
        }
    }

    productTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateSpecifications);
    });

    document.getElementById('electronics_category').addEventListener('change', updateElectronicsFields);
    document.getElementById('decoration_type').addEventListener('change', updateDecorationSpecs);
    document.getElementById('needs_custom_quote').addEventListener('change', updateDecorationSpecs);

    updateSpecifications();
});

// Fonction pour pr√©visualiser l'image principale
function previewMainImage(input) {
    const preview = document.getElementById('main-preview');
    const previewContainer = document.getElementById('main-image-preview');
    const fileName = document.getElementById('main-file-name');
    const fileSize = document.getElementById('main-file-size');

    if (input.files && input.files[0]) {
        const file = input.files[0];
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

        if (!validTypes.includes(file.type)) {
            alert('Format non support√©. Utilisez JPG, PNG, GIF ou WebP.');
            input.value = '';
            return;
        }

        if (file.size > 10 * 1024 * 1024) {
            alert('Fichier trop volumineux (max 10MB).');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            fileName.textContent = file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name;
            fileSize.textContent = formatFileSize(file.size);
            previewContainer.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Gestion des images suppl√©mentaires dynamiques
let additionalImageCount = 1;
const MAX_ADDITIONAL_IMAGES = 5;

function addAdditionalImageField() {
    if (additionalImageCount >= MAX_ADDITIONAL_IMAGES) {
        alert(`Vous ne pouvez pas ajouter plus de ${MAX_ADDITIONAL_IMAGES} images suppl√©mentaires.`);
        return;
    }

    const container = document.getElementById('additional-images-container');
    const newField = document.createElement('div');
    newField.className = 'additional-image-field border border-gray-300 rounded-lg p-4 bg-green-50';
    newField.innerHTML = `
        <div class="flex items-center justify-between mb-3">
            <label class="block text-sm font-medium text-gray-700">Nouvelle image suppl√©mentaire ${additionalImageCount + 1}</label>
            <button type="button" onclick="removeAdditionalImageField(this)" class="text-red-600 hover:text-red-800 text-sm flex items-center gap-1">
                <span class="material-symbols-outlined text-base">delete</span>
                Supprimer
            </button>
        </div>
        <input type="file" name="additional_images" class="block w-full text-xs sm:text-sm text-gray-500 file:mr-2 sm:file:mr-4 file:py-2 sm:file:py-3 file:px-3 sm:file:px-4 file:rounded-lg file:border-0 file:text-xs sm:file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700 transition-colors border border-gray-300 rounded-lg" accept="image/*" onchange="previewAdditionalImage(this, ${additionalImageCount})">
        <div id="additional-preview-${additionalImageCount}" class="mt-3 hidden p-3 bg-white rounded-lg border">
            <p class="text-sm font-medium text-gray-700 mb-2">Aper√ßu :</p>
            <div class="flex items-center space-x-4">
                <img id="additional-img-${additionalImageCount}" class="h-16 w-16 object-cover rounded-lg border border-gray-300">
                <div>
                    <p id="additional-file-name-${additionalImageCount}" class="text-sm font-medium text-gray-900"></p>
                    <p id="additional-file-size-${additionalImageCount}" class="text-xs text-gray-500"></p>
                </div>
            </div>
        </div>
    `;
    container.appendChild(newField);
    additionalImageCount++;
}

function removeAdditionalImageField(button) {
    const field = button.closest('.additional-image-field');
    field.remove();
    reorganizeAdditionalImageFields();
}

function reorganizeAdditionalImageFields() {
    const container = document.getElementById('additional-images-container');
    const fields = container.querySelectorAll('.additional-image-field');
    additionalImageCount = fields.length;
    fields.forEach((field, index) => {
        const label = field.querySelector('label');
        label.textContent = `Nouvelle image suppl√©mentaire ${index + 1}`;
        const input = field.querySelector('input[type="file"]');
        input.setAttribute('onchange', `previewAdditionalImage(this, ${index})`);
        const previewContainer = field.querySelector(`[id^="additional-preview-"]`);
        const previewImg = field.querySelector(`[id^="additional-img-"]`);
        const fileName = field.querySelector(`[id^="additional-file-name-"]`);
        const fileSize = field.querySelector(`[id^="additional-file-size-"]`);
        if (previewContainer) previewContainer.id = `additional-preview-${index}`;
        if (previewImg) previewImg.id = `additional-img-${index}`;
        if (fileName) fileName.id = `additional-file-name-${index}`;
        if (fileSize) fileSize.id = `additional-file-size-${index}`;
    });
}

function previewAdditionalImage(input, index) {
    const preview = document.getElementById(`additional-img-${index}`);
    const previewContainer = document.getElementById(`additional-preview-${index}`);
    const fileName = document.getElementById(`additional-file-name-${index}`);
    const fileSize = document.getElementById(`additional-file-size-${index}`);

    if (input.files && input.files[0]) {
        const file = input.files[0];
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('Format non support√©. Utilisez JPG, PNG, GIF ou WebP.');
            input.value = '';
            return;
        }
        if (file.size > 10 * 1024 * 1024) {
            alert('Fichier trop volumineux (max 10MB).');
            input.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            fileName.textContent = file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name;
            fileSize.textContent = formatFileSize(file.size);
            previewContainer.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    } else {
        previewContainer.classList.add('hidden');
    }
}

// Validation avant soumission - VERSION SIMPLIFI√âE
document.querySelector('form').addEventListener('submit', function(e) {
    console.log("=== AVANT SOUMISSION ===");
    console.log("Images √† supprimer:", imagesToRemove);

    // V√©rifier les champs cach√©s
    const hiddenFields = document.querySelectorAll('input[name="remove_image_ids"]');
    console.log("Champs cach√©s trouv√©s:", hiddenFields.length);
    hiddenFields.forEach((field, index) => {
        console.log(`Champ ${index + 1}:`, field.name, "=", field.value);
    });

    e.preventDefault();

    // Validation des champs de base
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();
    const price = document.getElementById('price').value;
    const stock = document.getElementById('stock').value;
    const productType = document.querySelector('input[name="product_type"]:checked');

    let errorMessages = [];
    if (!name) errorMessages.push('Le nom est requis');
    if (!description) errorMessages.push('La description est requise');
    if (!stock || isNaN(stock) || parseInt(stock) < 0) errorMessages.push('Le stock doit √™tre un nombre positif ou z√©ro');
    if (!productType) errorMessages.push('Le type de produit est requis');

    if (productType) {
        const needsCustomQuote = document.getElementById('needs_custom_quote') ? document.getElementById('needs_custom_quote').checked : false;
        if (productType.value === 'DECORATION' && needsCustomQuote) {
            // Pas de validation de prix pour les produits sur devis
        } else {
            if (!price || isNaN(price) || parseFloat(price) <= 0) {
                errorMessages.push('Le prix doit √™tre un nombre positif');
            }
        }
    }

    if (errorMessages.length > 0) {
        alert('ERREURS:\n' + errorMessages.join('\n'));
        return false;
    }

    // Si tout est valide, soumettre
    const submitButton = document.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> Modification en cours...';
    submitButton.disabled = true;

    setTimeout(() => {
        this.submit();
    }, 100);
});

// Optimisation pour mobile
if (window.innerWidth <= 768) {
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.style.fontSize = '16px';
        });
    });
}
</script>



<style>
.existing-image-field.marked-for-deletion,
.existing-image-field.to-be-deleted {
    background-color: #fef2f2 !important;
    border: 2px dashed #ef4444 !important;
    opacity: 0.6;
}
.existing-image-field {
    transition: all 0.3s ease;
}
</style>
{% endblock %}