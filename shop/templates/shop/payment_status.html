<!-- shop/templates/shop/payment_status.html -->
{% extends 'shop/base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto text-center">
        {% if order %}
        <div id="status-container">
            <!-- État initial -->
            <div id="checking" class="mb-6">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary mx-auto mb-4"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2">Vérification du paiement</h2>
                <p class="text-slate-600">Veuillez patienter pendant que nous vérifions votre paiement...</p>
            </div>

            <!-- États finaux -->
            <div id="success" class="hidden mb-6">
                <div class="text-green-500 text-6xl mb-4">✅</div>
                <h2 class="text-xl font-bold text-slate-900 mb-2">Paiement Réussi !</h2>
                <p class="text-slate-600 mb-4">Votre commande <strong>#{{ order.order_number }}</strong> a été confirmée.</p>
                <a href="{% url 'shop:order_confirmation' order.id %}" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 transition-colors">
                    Voir ma commande
                </a>
            </div>

            <div id="failed" class="hidden mb-6">
                <div class="text-red-500 text-6xl mb-4">❌</div>
                <h2 class="text-xl font-bold text-slate-900 mb-2">Paiement Annulé</h2>
                <p class="text-slate-600 mb-4">Votre commande a été annulée.</p>
                <a href="{% url 'shop:cart_detail' %}" class="bg-slate-500 text-white px-6 py-3 rounded-lg hover:bg-slate-600 transition-colors">
                    Retour au panier
                </a>
            </div>

            <div id="pending" class="hidden mb-6">
                <div class="text-blue-500 text-6xl mb-4">⏳</div>
                <h2 class="text-xl font-bold text-slate-900 mb-2">En attente</h2>
                <p class="text-slate-600 mb-4">Votre paiement est toujours en cours de traitement.</p>
                <p class="text-sm text-slate-500">Vous recevrez un email de confirmation une fois le paiement validé.</p>
                <a href="{% url 'shop:home' %}" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 transition-colors mt-4">
                    Retour à l'accueil
                </a>
            </div>
        </div>
        {% else %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
            <h2 class="text-xl font-bold text-yellow-800 mb-2">Aucune commande en attente</h2>
            <p class="text-yellow-700">Nous n'avons pas trouvé de commande en cours de paiement.</p>
            <a href="{% url 'shop:home' %}" class="inline-block bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 transition-colors mt-4">
                Retour à l'accueil
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% if order %}
<script>
const orderId = {{ order.id }};
let checkCount = 0;
const maxChecks = 60; // 10 minutes

function checkStatus() {
    fetch(`/api/payment-status/${orderId}/`)
        .then(r => r.json())
        .then(data => {
            checkCount++;

            if (data.is_paid) {
                showState('success');
            } else if (data.is_failed) {
                showState('failed');
            } else if (checkCount >= maxChecks) {
                showState('pending');
            } else {
                setTimeout(checkStatus, 5000); // Vérifier toutes les 5 secondes
            }
        })
        .catch(() => {
            if (checkCount < maxChecks) {
                setTimeout(checkStatus, 5000);
            } else {
                showState('pending');
            }
        });
}

function showState(state) {
    document.getElementById('checking').classList.add('hidden');
    document.getElementById(state).classList.remove('hidden');
}

// Démarrer la vérification
setTimeout(checkStatus, 2000); // Commencer après 2 secondes
</script>
{% endif %}
{% endblock %}